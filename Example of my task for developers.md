## Comment:
>На данный момент все свои задачи для команды я готовлю и веду в GitLab.
>Поэтому в данном примере я привожу простую копию обычной моей задачи из GitLab.
>К сожалению, часть функционала, доступная для моих разработчиков, здесь не отражена.
>Но я надеюсь, что материла, для формирования общего представление о моих подходах и применяемых мною принципов, будет достаточно.


# [ЛКК][Биллинг][Эквайринг][Бэк]: оплата АД картой

Необходимо подготовить бэк для сервиса оплаты АД в ЛКК - основная задача: NdvCabinet/ClientCabinetFront#77    

**Краткий список подзадач:**
* [ ] 1. Научиться писать запрос регистрации заказа, передача корзины (register.do) и получать ответ
* [ ] 2. Научиться писать запрос состояния заказа (getOrderStatusExtended.do) и получать ответ
* [ ] 3. Научится создавать БП Payment с доп. параметрами
* [ ] 4. Автоматическое создание платежа и изменения статуса платёжного поручения    
Функционал для менеджера в CRM:    
* [ ] 5. В БП чата добавить группу кнопок "Быстрые действия", в которой нужно разместить кнопку "Направить клиенту счёт на оплату АД".
* [ ] 6. Активация кнопки "Направить клиенту счёт на оплату АД" провоцирует проверку
* [ ] 7. По факту сохранения формы    
Функционал для пользователя в ЛКК:    
* [ ] 10. После активации пользователем кнопки "Оплатить", производиться проверка 

Основное требование и документация: https://securepayments.sberbank.ru/wiki/doku.php/integration:api:start#%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D0%B0_%D1%81_%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D0%B5%D0%B9_%D1%87%D0%B5%D0%BA%D0%BE%D0%B2_%D0%BD%D0%B0_%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE-%D0%BA%D0%B0%D1%81%D1%81%D0%BE%D0%B2%D0%BE%D0%B9_%D1%82%D0%B5%D1%85%D0%BD%D0%B8%D0%BA%D0%B5

**Сценарий сервиса:**
1. Менеджер отправляет интерактивное сообщение из CRM, которое позволит клиенту совершить оплату по АД 
2. Выводим в сообщении чата сделки ЛКК кнопку, активация которой провоцирует: обновление данных в соответствующем БП Payment в CRM в рамках Bookkeeping (п.3.) и отправку запроса register.do (п.1.).
    * Кнопка для оплаты будет позволять совершить оплату пользователю только в тех чатах, у которых в сделке есть АД с платёжным поручением (статус платёжного поручения должен быть: `processing`), который имеет связь с продавцом, у которого параметр "Сделать доступным интернет-эквайринг" = "true" (задача: NdvCrm/crm#1837).
3. Проведя проверку по полученному параметру из запросов register.do `errorCode` и сохранив параметр `orderId`, перенаправляем пользователя на страницу, которая указана в параметре `formUrl`.
4. Клиент вводит параметры своей банковской карты
5. После проведения оплаты происходит процедура 3-D Secure, если у банк клиента её поддерживает:
    * Если всё ок, у клиента списывают деньги, которые мы запросили в запросе register.do и направляют на `returnUrl`
    * Если проверка 3-D Secure была провалена или произошла ошибка при оплате, клиента перенаправляют на: `failUrl` из register.do
5. Используя параметр `orderId` полученный из запроса register.do, делаем запрос getOrderStatusExtended.do
6. Проведя проверку по параметру `actionCode`: если значение "0" - берём значения `amount`, `date`
7. Обновляем в CRM платёж и платёжное поручение с использованием полученных параметров.
8. Обновляем статус платёжного поручения в CRM и в ЛКК
9.1. Направляется нотификация
9.2. В связанную с bookkeeping АД делаем запись в Историю БП

**Подзадачи:**
1. Научиться писать запрос регистрации заказа, передача корзины (register.do) и получать ответ: https://securepayments.sberbank.ru/wiki/doku.php/integration:api:rest:requests:register_cart#additionalofdparams
* `userName`: ndv-api (тестовый, боевой будет чуть позже) 
* `password`: ndv (тестовый, боевой будет чуть позже)
* `orderNumber`: id создаваемого БД платежа
* `amount`: сумма по остатку платежа в копейках
* `returnUrl`: нужно сгенерировать промежуточную ссылку для создания тригера на отправку запроса getOrderStatusExtended.do
* `failUrl`: нужно сгенерировать промежуточную ссылку для создания тригера на отправку запроса getOrderStatusExtended.do
* `additionalOfdParams`:
    * Пока передаём пустой массив
* `description`: "Оплата договора №[Номер договора, который получаем из БП АД, связанного с платёжным поручением]"    

1.1. Получаемый нами ответ:
* `formUrl` - URL-адрес платёжной формы, на который нужно перенаправить браузер клиента. Не возвращается, если регистрация заказа не удалась по причине ошибки, детализированной в errorCode. Для перенаправления пользователя на страницу оплаты через Сбербанк Онлайн добавьте GET-параметр toWeb2App=true к адресу, который передаётся в параметре formUrl.
* `errorCode` - Код ошибки. Может отсутствовать, если результат не привёл к ошибке.
* `orderId` - Номер заказа в платёжном шлюзе. Уникален в пределах шлюза.
* `errorMessage` - Описание ошибки на языке, переданном в параметре language в запросе.

2. Научиться писать запрос состояния заказа (getOrderStatusExtended.do) и получать ответ: https://securepayments.sberbank.ru/wiki/doku.php/integration:api:rest:requests:getorderstatusextended_cart
* `userName`: ndv-api (тестовый, боевой будет чуть позже) 
* `password`: ndv (тестовый, боевой будет чуть позже)
* `orderId`: значение, получаемое в ответ на запрос register.do
* `orderNumber`: из запроса register.do (п.1.)

2.1. Получаемый нами ответ:
* orderNumber: из запроса register.do (п.1.)
* orderStatus: (0 - заказ успешно зарегистрирован)
* actionCode: (0 - платёж успешно прошёл)
* actionCodeDescription (0 - платёж успешно прошёл)
* errorCode
* errorMessage
* amount
* date
* ip
* paymentSystem
* product
* paymentWay

3. Научится обновлять БП Payment и дополнить его доп. параметрами:    
3.1. Заполненные параметры БП Payment, а также те параметры, которые участвуют в отправке запроса register.do:    
* `status` "Статус": "processing" - статус при создании БП Payment
* id БП в дальнейшем будем использовать для `orderNumber` в register.do
* `amount` "Сумма" - заполняется значением из графика платежей
* `date` "Дата" - дата создания БП Payment
* `type` "Тип платежа": "revenue"    
Дополнительный параметр, который нужно добавить в платёж перед отправкой запроса register.do:    
* `description` (тип - str): "Оплата договора №[Номер договора, который получаем из БП АД, связанного с платёжным поручением]"    
* `errorCode`: null
* `actionCode`: null
* `errorMessage`: null
    
3.1.1. После получения ответа по запросу register.do:    
* Если значение `errorCode` запроса "register.do" = 0 или null, обновляем значение `errorCode`    
* Иначе: обновляем значения `errorCode` на полученное из запроса, обновляем значение параметра `status` "Статус": "cancel"    

3.2. Обновление значений параметров после получения ответа по запросу getOrderStatusExtended.do:    
* `status` "Статус":
    * Если значения параметра `actionCode` = 0, обновляем значение `status` "Статус" на `paid`
    * Иначе: обновляем значение параметра `status` "Статус" на "cancel"
* `actionCode`:
    * Записываем значение из ответа по запросу getOrderStatusExtended.do
* `errorMessage`:
    * Записываем значение из ответа по запросу getOrderStatusExtended.do

4. Автоматическое обновление платежа и изменения статуса платёжного поручения:
* Менеджер отправляет интерактивное сообщение из CRM, которое позволит клиенту совершить оплату по АД 
* После того, как клиент активировал кнопку совершения оплаты банковской картой в ЛКК:
    * Обновляем БП Payment (п.3.1.) в платёжном поручении соответствующего АД, согласно указанным менеджером данных (п.5.)
    * формируем запрос register.do.
* Получив и сохранив ответ (обновляем БП Payment (п.3.1.1.)):
    * Если `errorCode` != 0 или null, создаём сообщение в чат от "Лизы": "Что-то в Сбербанке пошло не так... Банк отказывается принимать вашу оплату по причине: "[значение параметра `errorMessage` из register.do]". Попробуйте ещё раз или воспользуйтесь мобильным приложением вашего банка".
* Дожидаемся, когда клиент совершит платёж и будет перенаправлен на страницу `returnUrl` из запроса register.do.
* После завершения процедуры оплаты со стороны клиента в платёжном сервисе, пользователь перенаправляется на `returnUrl` или `failUrl`
* По факту перехода пользователя делаем запрос getOrderStatusExtended.do
* Получив ответ, обновляем БП Payment, id которого = значению параметра `orderNumber` (п.3.2.)
* Проводим проверку по bookkeeping: Если сумма остатка в графике платежей bookkeeping = 0, меняем статус bookkeeping на `paid`

**Функционал для менеджера в CRM:**

5. В БП чата добавить группу кнопок "Быстрые действия", в которой нужно разместить кнопку "Направить клиенту счёт на оплату АД".    

Продажная: https://system.ndv.ru/#/widget/show_business_process?id=26310531

6. Активация кнопки "Направить клиенту счёт на оплату АД" провоцирует проверку:
* Есть ли у карточки клиента, которая связана с чатом, и квартиры общая нерасторгнутая Сделка:
    * Если есть, проводим проверку: есть ли в данных Сделках нерасторгнутые АД с bookkeeping в статусе `processing`
        * Если есть, открываем форму со следующими полями:
            * "Платёжное поручение АД" - поле с выпадающим списком активных платёжных поручений, которые связаны с нерасторгнутыми АД, связанные со Сделками, у которых есть связь с Клиентом и Объектом недвижимости Чата. Выбрать из списка можно только один АД.
            * "Сумма платежа" - поле для ввода положительной суммы.
        * Если нет, выводим ошибку: "У данного Клиента нет ни одного активного Платёжного поручения, который создаётся после подписания АД".
    * Если нет, выводим ошибку: "У данного Клиента нет ни одной активной Сделки"    

7. По факту активации кнопки "Сохранить" формы:
* проводим проверку суммы:
    * Если совокупная сумма остатка для оплаты Клиента в графике платежей выбранного менеджером платёжного поручения < указанного пользователем в форме платежа - форму не сохраняем, выводим пользователю CRM ошибку: "Сумма платежа больше, чем остаток по АД"
* Создаём сообщение в чате от пользователя, который сохранил форму:
    * Содержание: "Счёт на оплату [Значение из поля "Сумма платежа", которую указал пользователь CRM] руб по Агентскому договору" + Кнопка "Оплатить"

8. По факту совершения клиентом платежа ответственным менеджерам (менеджер новостройки, менеджер ипотеки, со-менеджер):    

9.1. Направляется нотификация:
* Содержание: "Клиент совершил оплату по АД"
* importance: info
* priority: 0 - группировка "Уведомления"
* Кнопка "Перейти" ведёт в АД
* Декативация: по факту открытия пользователем БП АД     

9.2. В связанную с bookkeeping АД делаем запись в Историю БП:
* Заголовок: "Клиент совершил оплату по АД" - кликабельная ссылка на АД
* Дата и время
* Содержание: "Сумма оплаты: [Сумма внесённого платежа] рублей"
* Автор    

**Функционал для пользователя в ЛКК:**    
10. После активации пользователем кнопки "Оплатить", производиться проверка:
* Оплачен ли платёж:
    * если платёж оплачен, выводим сообщение клиенту: "Ранее, Вы уже успешно оплатили данный платёж. Для большей информации обратитесь к Вашему персональному менеджеру"
    * Если платёж не оплачен, запускаем сценарий из п.4, с отправкой запроса register.do
